#############################################################################
# data_fetcher.py
#
# This file contains functions to fetch data needed for the app.
#
# You will re-write these functions in Unit 3, and are welcome to alter the
# data returned in the meantime. We will replace this file with other data when
# testing earlier units.
#############################################################################

import random
import numpy as np
import pandas as pd
from scipy.signal import find_peaks


users = {
    'user1': {
        'full_name': 'Remi',
        'username': 'remi_the_rems',
        'date_of_birth': '1990-01-01',
        'profile_image': 'https://upload.wikimedia.org/wikipedia/commons/c/c8/Puma_shoes.jpg',
        'friends': ['user2', 'user3', 'user4'],
    },
    'user2': {
        'full_name': 'Blake',
        'username': 'blake',
        'date_of_birth': '1990-01-01',
        'profile_image': 'https://upload.wikimedia.org/wikipedia/commons/c/c8/Puma_shoes.jpg',
        'friends': ['user1'],
    },
    'user3': {
        'full_name': 'Jordan',
        'username': 'jordanjordanjordan',
        'date_of_birth': '1990-01-01',
        'profile_image': 'https://upload.wikimedia.org/wikipedia/commons/c/c8/Puma_shoes.jpg',
        'friends': ['user1', 'user4'],
    },
    'user4': {
        'full_name': 'Gemmy',
        'username': 'gems',
        'date_of_birth': '1990-01-01',
        'profile_image': 'https://upload.wikimedia.org/wikipedia/commons/c/c8/Puma_shoes.jpg',
        'friends': ['user1', 'user3'],
    },
}


def get_user_sensor_data(user_id, workout_id):
    """Returns a list of timestampped information for a given workout.

    This function currently returns random data. You will re-write it in Unit 3.
    """
    sensor_data = []
    sensor_types = [
        'accelerometer',
        'gyroscope',
        'pressure',
        'temperature',
        'heart_rate',
    ]
    for index in range(random.randint(5, 100)):
        random_minute = str(random.randint(0, 59))
        if len(random_minute) == 1:
            random_minute = '0' + random_minute
        timestamp = '2024-01-01 00:' + random_minute + ':00'
        data = random.random() * 100
        sensor_type = random.choice(sensor_types)
        sensor_data.append(
            {'sensor_type': sensor_type, 'timestamp': timestamp, 'data': data}
        )
    return sensor_data

# modify later to be able to make any data graphable
def calculate_sensor_data(sensor_data, sensor_type, data_field):
    """Extracts and aggregates values from sensor data for a given sensor type and field."""
    sensor_counts = {}

    filtered_data = list(filter(lambda entry: entry['sensor_type'] == sensor_type, sensor_data))

    for entry in filtered_data:
        timestamp = entry['timestamp']
        data = entry['data']

        if isinstance(data, dict):
            value = data.get(data_field)
            if value is not None:
                sensor_counts[timestamp] = sensor_counts.get(timestamp, 0) + value
        elif isinstance(data, (int, float)):
            if data_field == None:
                sensor_counts[timestamp] = sensor_counts.get(timestamp, 0) + data
        else:
            print(f"Warning: Unexpected data type for timestamp {timestamp}: {type(data)}")

    return sensor_counts

def get_sensor_data(user_id, workouts_list, sensor_type, data_field):
    """Aggregates sensor data (steps, heart rate, etc.) across all workouts."""
    all_sensor_data = {}

    for workout in workouts_list:
        workout_id = workout['workout_id']
        sensor_data = get_user_sensor_data(user_id, workout_id)  # Fetch sensor data
        sensor_values = calculate_sensor_data(sensor_data, sensor_type, data_field)

        for timestamp, value in sensor_values.items():
            all_sensor_data[timestamp] = all_sensor_data.get(timestamp, 0) + value

    # Convert to DataFrame
    sensor_df = pd.DataFrame(list(all_sensor_data.items()), columns=["timestamp", data_field])
    sensor_df = sensor_df.sort_values(by="timestamp")

    return sensor_df


def get_user_workouts(user_id):
    """Returns a list of user's workouts.

    This function currently returns random data. You will re-write it in Unit 3.
    """
    workouts = []
    for index in range(random.randint(1, 3)):
        random_lat_lng_1 = (
            1 + random.randint(0, 100) / 100,
            4 + random.randint(0, 100) / 100,
        )
        random_lat_lng_2 = (
            1 + random.randint(0, 100) / 100,
            4 + random.randint(0, 100) / 100,
        )
        workouts.append({
            'workout_id': f'workout{index}',
            'start_timestamp': '2024-01-01 00:00:00',
            'end_timestamp': '2024-01-01 00:30:00',
            'start_lat_lng': random_lat_lng_1,
            'end_lat_lng': random_lat_lng_2,
            'distance': random.randint(0, 200) / 10.0,
            'steps': random.randint(0, 20000),
            'calories_burned': random.randint(0, 100),
        })
    return workouts


def get_user_profile(user_id):
    """Returns information about the given user.

    This function currently returns random data. You will re-write it in Unit 3.
    """
    if user_id not in users:
        raise ValueError(f'User {user_id} not found.')
    return users[user_id]


def get_user_posts(user_id):
    """Returns a list of a user's posts.

    This function currently returns random data. You will re-write it in Unit 3.
    """
    content = random.choice([
        'Had a great workout today!',
        'The AI really motivated me to push myself further, I ran 10 miles!',
    ])
    return [{
        'user_id': user_id,
        'post_id': 'post1',
        'timestamp': '2024-01-01 00:00:00',
        'content': content,
        'image': 'image_url',
    }]


def get_genai_advice(user_id):
    """Returns the most recent advice from the genai model.

    This function currently returns random data. You will re-write it in Unit 3.
    """
    advice = random.choice([
        'Your heart rate indicates you can push yourself further. You got this!',
        'You worked hard yesterday, take it easy today.',
        'You have burned 100 calories so far today!',
        'Every step brings you closer to your goal. Keep moving!',
        'Stay strong, the effort you put in today pays off tomorrow.',
        'Keep the pace! Your endurance is your strength.'
    ])
    image = random.choice([
        'https://plus.unsplash.com/premium_photo-1669048780129-051d670fa2d1?q=80&w=3870&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D',
    ])
    return {
        'advice_id': 'advice1',
        'timestamp': '2024-01-01 00:00:00',
        'content': advice,
        'image': image,
        'time_progress': '13:02'
    }
